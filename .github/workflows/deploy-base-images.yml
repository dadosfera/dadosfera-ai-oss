name: Deploy to Docker Hub

on:
  push:
    branches:
      - master

jobs:
  semantic_release:
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v3
        id: semantic
        with:
          semantic_version: 19
          extra_plugins: |
            @saithodev/semantic-release-backmerge@2
            conventional-changelog-eslint@4.0.0
          branches: |
            [
              'master',
              {
                name: 'alpha',
                prerelease: true
              },
              {
                name: 'beta',
                prerelease: true
              }
            ]
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check-changes-in-paths:
    runs-on: ubuntu-latest
    outputs:
      dadosfera-base-kernel-py: ${{ steps.check-changes-in-paths.outputs.dadosfera-base-kernel-py }}
      dadosfera-base-kernel-py-agent: ${{ steps.check-changes-in-paths.outputs.dadosfera-base-kernel-py-agent }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for changes in paths
        id: check-changes-in-paths
        uses: dorny/paths-filter@v2
        with:
          filters: |
            dadosfera-base-kernel-py:
              - 'services/base-images/dadosfera-base-kernel-py/**'
              - '.github/workflows/build-push-image.yml'
            dadosfera-base-kernel-py-agent:
              - 'services/base-images/dadosfera-base-kernel-py-agent/**'
              - '.github/workflows/build-push-image.yml'

  build_dadosfera_base_kernel_py:
    needs: [check-changes-in-paths]
    if: needs.check-changes-in-paths.outputs.dadosfera-base-kernel-py == 'true'
    uses: ./.github/workflows/build-push-image.yml
    with:
      image-directory: services/base-images/dadosfera-base-kernel-py
      dockerhub-username: dadosfera
      image-name: base-kernel-py
    secrets: inherit

  build_dadosfera_base_kernel_py_agent:
    needs: [check-changes-in-paths]
    if: needs.check-changes-in-paths.outputs.dadosfera-base-kernel-py-agent == 'true'
    uses: ./.github/workflows/build-push-image.yml
    with:
      image-directory: services/base-images/dadosfera-base-kernel-py-agent
      dockerhub-username: dadosfera
      image-name: base-kernel-py-agent
    secrets: inherit

  build_orchest_controller:
    needs: [semantic_release]
    if: ${{ needs.semantic_release.outputs.new_release_published == 'true' }}
    uses: ./.github/workflows/build-push-image.yml
    with:
      image-directory: services/base-images/dadosfera-base-kernel-py-agent
      dockerhub-username: dadosfera
      image-name: orchest-controller
      image-tag: ${{ needs.semantic_release.outputs.new_release_published }}
    secrets: inherit
  